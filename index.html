<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat ‚Äî PT Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        .msg-ai { background: #f3f4f6; color: black; }
        .msg-you { background: black; color: white; margin-left: auto; }
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
    </style>
</head>
<body class="bg-white text-black min-h-screen">
    <div class="max-w-4xl mx-auto p-4">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 p-4 border-b">
            <h1 class="text-2xl font-bold">ü§ñ AI Chat by Cikal</h1>
            <button onclick="newChat()" class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800">
                + New Chat
            </button>
        </div>

        <!-- Chat Container -->
        <div id="chat" class="space-y-4 mb-6 min-h-[60vh] max-h-[70vh] overflow-y-auto p-2"></div>

        <!-- Input Area -->
        <div class="border-t pt-4">
            <div class="flex gap-2 mb-2">
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImage()">
                <button onclick="document.getElementById('fileInput').click()" 
                        class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
                    üìÅ Upload Image
                </button>
                <div id="imagePreview" class="hidden items-center gap-2">
                    <img id="previewImg" class="h-10 w-10 object-cover rounded">
                    <button onclick="cancelImage()" class="text-red-500">√ó</button>
                </div>
            </div>
            
            <div class="flex gap-2">
                <input type="text" 
                       id="userInput" 
                       placeholder="Tanya apa saja..."
                       class="flex-1 p-3 border rounded focus:outline-none focus:ring-2 focus:ring-black"
                       onkeypress="if(event.key=='Enter') sendMessage()">
                <button onclick="sendMessage()" 
                        id="sendBtn"
                        class="px-6 py-3 bg-black text-white rounded font-bold hover:bg-gray-800">
                    Kirim
                </button>
            </div>
            
            <p class="text-gray-500 text-sm mt-2">
                ‚ú® Powered by Gemini AI ‚Ä¢ Free tier Vercel
            </p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg">
            <div class="w-8 h-8 border-4 border-black border-t-transparent rounded-full animate-spin mx-auto"></div>
            <p class="mt-2">Thinking...</p>
        </div>
    </div>

<script>
// ===== CONFIGURASI =====
const GEMINI_API_KEY = "<?= process.env.GEMINI_API_KEY ?>"; // Akan diganti Vercel

// ===== STATE =====
let currentChat = [];
let pendingImage = null;

// ===== FUNGSI UTAMA =====
async function sendMessage() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    
    if (!text && !pendingImage) return;
    
    // Disable input sementara
    input.value = '';
    input.disabled = true;
    document.getElementById('sendBtn').disabled = true;
    document.getElementById('loading').classList.remove('hidden');
    
    // Tampilkan pesan user
    if (text) {
        addMessage(text, 'you');
        currentChat.push({ role: 'user', content: text });
    }
    
    // Tampilkan preview gambar
    if (pendingImage) {
        addImageMessage(pendingImage, 'you');
        currentChat.push({ role: 'user', image: pendingImage });
    }
    
    // Kirim ke API
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: text,
                image: pendingImage
            })
        });
        
        const data = await response.json();
        
        // Tampilkan response AI
        addMessage(data.reply || "Maaf, error terjadi", 'ai');
        currentChat.push({ role: 'assistant', content: data.reply });
        
    } catch (error) {
        addMessage("Error: " + error.message, 'ai');
        console.error("Error:", error);
    }
    
    // Reset state
    pendingImage = null;
    document.getElementById('imagePreview').classList.add('hidden');
    input.disabled = false;
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('loading').classList.add('hidden');
    input.focus();
}

// ===== FUNGSI BANTUAN =====
function addMessage(text, sender) {
    const chatDiv = document.getElementById('chat');
    const msgDiv = document.createElement('div');
    
    msgDiv.className = `p-4 rounded-lg max-w-[80%] ${sender === 'ai' ? 'msg-ai' : 'msg-you'}`;
    msgDiv.innerHTML = formatMessage(text);
    
    chatDiv.appendChild(msgDiv);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

function addImageMessage(imageData, sender) {
    const chatDiv = document.getElementById('chat');
    const container = document.createElement('div');
    
    container.className = `mb-2 ${sender === 'you' ? 'text-right' : 'text-left'}`;
    container.innerHTML = `
        <img src="${imageData}" class="max-w-[300px] rounded-lg shadow inline-block">
    `;
    
    chatDiv.appendChild(container);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

function formatMessage(text) {
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>')
        .replace(/`(.*?)`/g, '<code class="bg-gray-200 px-1 rounded">$1</code>');
}

function handleImage() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return;
    
    // Validasi ukuran (max 4.5MB untuk Vercel free)
    if (file.size > 4.5 * 1024 * 1024) {
        alert('Ukuran file maksimal 4.5MB untuk Vercel free tier');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        pendingImage = e.target.result;
        
        // Tampilkan preview
        document.getElementById('previewImg').src = pendingImage;
        document.getElementById('imagePreview').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
}

function cancelImage() {
    pendingImage = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('imagePreview').classList.add('hidden');
}

function newChat() {
    if (confirm('Buat chat baru?')) {
        currentChat = [];
        document.getElementById('chat').innerHTML = '';
        pendingImage = null;
        cancelImage();
    }
}

// Enter to send
document.getElementById('userInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
</script>

<!-- Vercel akan proses bagian PHP ini saat deploy -->
<?php if ($_SERVER['REQUEST_URI'] === '/api/chat' && $_SERVER['REQUEST_METHOD'] === 'POST'): ?>
<?php
// Ini akan jadi Serverless Function di Vercel
header('Content-Type: application/json');
$data = json_decode(file_get_contents('php://input'), true);

// Call Gemini API
$apiKey = getenv('GEMINI_API_KEY');
$url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" . $apiKey;

$payload = ['contents' => [['role' => 'user', 'parts' => []]]];

// Tambah text jika ada
if (!empty($data['message'])) {
    $payload['contents'][0]['parts'][] = ['text' => $data['message']];
}

// Tambah gambar jika ada
if (!empty($data['image'])) {
    $base64 = explode(',', $data['image'])[1] ?? '';
    $mime = explode(';', explode(':', $data['image'])[1] ?? '')[0] ?? 'image/jpeg';
    
    $payload['contents'][0]['parts'][] = [
        'inlineData' => [
            'mimeType' => $mime,
            'data' => $base64
        ]
    ];
}

$ch = curl_init($url);
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($payload));
curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

$response = curl_exec($ch);
curl_close($ch);

$result = json_decode($response, true);
$reply = $result['candidates'][0]['content']['parts'][0]['text'] ?? 'Maaf, tidak ada jawaban.';

echo json_encode(['reply' => $reply]);
exit;
?>
<?php endif; ?>
</body>
</html>